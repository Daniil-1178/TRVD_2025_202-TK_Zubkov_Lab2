const express = require('express');
const mongoose = require('mongoose');
const mustacheExpress = require('mustache-express');
const path = require('path');
const session = require('express-session'); 
const MongoDBStore = require('connect-mongodb-session')(session); 
require('dotenv').config(); 

// ----------------------------------------------------
// 0. –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø –ú–ê–†–®–†–£–¢–Ü–í –¢–ê –ú–û–î–ï–õ–ï–ô
// ----------------------------------------------------
// –®–ª—è—Ö–∏ –¥–æ —Ñ–∞–π–ª—ñ–≤ –º–∞—Ä—à—Ä—É—Ç—ñ–≤ —É –∫–æ—Ä–µ–Ω–µ–≤—ñ–π –ø–∞–ø—Ü—ñ routes/
const userRoutes = require('./routes/user');
const noteRoutes = require('./routes/note');
// –®–ª—è—Ö –¥–æ –º–æ–¥–µ–ª—ñ User —É –∫–æ—Ä–µ–Ω–µ–≤—ñ–π –ø–∞–ø—Ü—ñ models/
const User = require('./models/user'); 

const app = express();

// ----------------------------------------------------
// 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø MUSTACHE
// ----------------------------------------------------
// –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Mustache —è–∫ —à–∞–±–ª–æ–Ω—ñ–∑–∞—Ç–æ—Ä–∞, –≤–∫–ª—é—á–∞—é—á–∏ partials
app.engine('mustache', mustacheExpress(
    path.join(__dirname, 'views/partials'), // –ü–∞–ø–∫–∞ –¥–ª—è partials
    '.mustache'
));
app.set('view engine', 'mustache');
app.set('views', path.join(__dirname, 'views'));

// ----------------------------------------------------
// 2. MIDDLEWARE –î–õ–Ø –û–ë–†–û–ë–ö–ò –¢–Ü–õ–ê –ó–ê–ü–ò–¢–£ –¢–ê –°–¢–ê–¢–ò–ß–ù–ò–• –§–ê–ô–õ–Ü–í
// ----------------------------------------------------
app.use(express.urlencoded({ extended: true })); // –î–ª—è –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö —Ñ–æ—Ä–º
app.use(express.json()); // –î–ª—è –æ–±—Ä–æ–±–∫–∏ JSON-–¥–∞–Ω–∏—Ö
app.use(express.static(path.join(__dirname, 'public'))); // –û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—á–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤

// ----------------------------------------------------
// 3. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –°–•–û–í–ò–©–ê –°–ï–°–Ü–ô (MONGODB)
// ----------------------------------------------------
const store = new MongoDBStore({
    uri: process.env.MONGODB_URI, 
    collection: 'sessions' // –ù–∞–∑–≤–∞ –∫–æ–ª–µ–∫—Ü—ñ—ó, –¥–µ –±—É–¥—É—Ç—å –∑–±–µ—Ä—ñ–≥–∞—Ç–∏—Å—è —Å–µ—Å—ñ—ó
});

// –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ —Å—Ö–æ–≤–∏—â–∞
store.on('error', function(error) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ö–æ–≤–∏—â–∞ —Å–µ—Å—ñ–π:', error);
});

// ----------------------------------------------------
// 4. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø MIDDLEWARE –°–ï–°–Ü–ô
// ----------------------------------------------------
app.use(
    session({
        secret: process.env.SESSION_SECRET || 'fallback-secret-key-please-change-me', 
        resave: false, 
        saveUninitialized: false, 
        store: store, 
        cookie: {
            maxAge: 1000 * 60 * 60 * 24 // –°–µ—Å—ñ—è –¥—ñ–π—Å–Ω–∞ 24 –≥–æ–¥–∏–Ω–∏
        }
    })
);

// ----------------------------------------------------
// 5. –ì–õ–û–ë–ê–õ–¨–ù–ò–ô MIDDLEWARE –î–õ–Ø –ê–í–¢–û–ú–ê–¢–ò–ß–ù–û–á –ü–ï–†–ï–î–ê–ß–Ü –î–ê–ù–ò–• –°–ï–°–Ü–á –¢–ê –ö–û–†–ò–°–¢–£–í–ê–ß–ê
// ----------------------------------------------------
// –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ async, –æ—Å–∫—ñ–ª—å–∫–∏ –º–∏ –≤–∑–∞—î–º–æ–¥—ñ—î–º–æ –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö
app.use(async (req, res, next) => {
    // 1. –ü–µ—Ä–µ–¥–∞—á–∞ –ø—Ä–∞–ø–æ—Ä—Ü—è isLoggedIn –≤ —É—Å—ñ —à–∞–±–ª–æ–Ω–∏
    res.locals.isLoggedIn = req.session.isLoggedIn || false; 

    // 2. –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ù–ï –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π, –∞–±–æ —Å–µ—Å—ñ—è –Ω–µ –º—ñ—Å—Ç–∏—Ç—å userId, –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ
    if (!req.session.userId) {
        return next();
    }

    try {
        // 3. –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø–æ–≤–Ω–∏–π –æ–±'—î–∫—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø–æ ID.
        const user = await User.findById(req.session.userId);
        
        if (user) {
            req.user = user; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–±'—î–∫—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —É –∑–∞–ø–∏—Ç—ñ (–¥–ª—è noteController)
            res.locals.userId = user._id; // –ü–µ—Ä–µ–¥–∞—î–º–æ ID –≤ —à–∞–±–ª–æ–Ω–∏
        }
        next();
    } catch (err) {
        // –Ø–∫—â–æ —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –∑ –ë–î
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —É —Å–µ—Å—ñ—ó:', err);
        next();
    }
});

// ----------------------------------------------------
// 6. –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø –ú–ê–†–®–†–£–¢–Ü–í
// ----------------------------------------------------
// –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≤—Å—ñ—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤
app.use(userRoutes);
app.use('/notes', noteRoutes);

// –ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞
app.get('/', (req, res) => {
    res.render('index', { pageTitle: '–ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞' });
});

// –û–±—Ä–æ–±–∫–∞ 404 (–ó–∞–≤–∂–¥–∏ –≤ –∫—ñ–Ω—Ü—ñ)
app.use((req, res) => {
    res.status(404).render('404', { pageTitle: '–°—Ç–æ—Ä—ñ–Ω–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞' });
});

// ----------------------------------------------------
// 7. –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø –î–û –ë–ê–ó–ò –î–ê–ù–ò–• –¢–ê –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê
// ----------------------------------------------------
mongoose
    .connect(process.env.MONGODB_URI)
    .then(() => {
        console.log('‚úÖ MongoDB —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ.');
        app.listen(3000, () => {
            console.log('üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ http://localhost:3000');
        });
    })
    .catch(err => {
        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ MongoDB:', err);
    });